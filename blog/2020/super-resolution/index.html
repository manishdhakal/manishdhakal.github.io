<!DOCTYPE html> <html lang="en"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> Super Resolution with GAN (SRGAN) using Keras API | Manish Dhakal </title> <meta name="author" content="Manish Dhakal"> <meta name="description" content="Implemented the code to increase the resolution of the 25x25 images 4x4."> <meta name="keywords" content="manish, manish-dhakal, academic-website"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="/assets/img/favicon.png?d1e8fd8284038ded39b57a852815be4b"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://manishdhakal.github.io/blog/2020/super-resolution/"> <script src="/assets/js/theme.js?a5ca4084d3b81624bcfa01156dae2b8e"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>initTheme();</script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Manish</span> Dhakal </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About </a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications </a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/">Blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">Repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV </a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">Super Resolution with GAN (SRGAN) using Keras API</h1> <p class="post-meta"> June 19, 2020 </p> <p class="post-tags"> <a href="/blog/2020"> <i class="fa-solid fa-calendar fa-sm"></i> 2020 </a>   ·   <a href="/blog/tag/computer-vision"> <i class="fa-solid fa-hashtag fa-sm"></i> computer-vision</a>   <a href="/blog/tag/super-resolution"> <i class="fa-solid fa-hashtag fa-sm"></i> super-resolution</a>     ·   <a href="/blog/category/technical-posts"> <i class="fa-solid fa-tag fa-sm"></i> technical-posts</a>   </p> </header> <article class="post-content"> <div id="markdown-content"> <div class="row mt-3"> <div class="col-xs mt-2 mx-auto"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogs/super_resolution/GAN-480.webp 480w,/assets/img/blogs/super_resolution/GAN-800.webp 800w,/assets/img/blogs/super_resolution/GAN-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogs/super_resolution/GAN.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">Image src: neuralnet.ai</figcaption> </figure> </div> </div> <p>This blog allows us to implement super-resolution in Python to increase the resolution of 25X25 images by 4X4.</p> <h2 id="prior-knowledge">Prior Knowledge</h2> <ul> <li>Neural Networks</li> <li>Python</li> <li>Keras</li> </ul> <h2 id="generative-adverserial-networks">Generative Adverserial Networks</h2> <p>GAN is the technology in the field of Neural Network innovated by Ian Goodfellow and his friends. <a href="https://arxiv.org/abs/1609.04802" rel="external nofollow noopener" target="_blank"> SRGAN </a> is the method by which we can increase the resolution of any image.</p> <div class="row mt-3"> <div class="col-xs mt-2 mx-auto"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogs/super_resolution/GAN_working-480.webp 480w,/assets/img/blogs/super_resolution/GAN_working-800.webp 800w,/assets/img/blogs/super_resolution/GAN_working-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogs/super_resolution/GAN_working.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">Image src: mc.ai</figcaption> </figure> </div> </div> <p>It contains basically two parts: a <b>Generator</b> and a <b>Discriminator</b>. The generator produces refined output data from given input noise. Discriminator receives two types of data: one is the real-world data and another is the generated output from the generator. For discriminator, real data has label ‘1’ and generated data has label ‘0’. We can take the analogy of the generator as an <b>artist</b> and the discriminator as a <b>critic</b>. Artists create an art form that is judged by the critic.</p> <div class="row mt-3"> <div class="col-xs mt-2 mx-auto"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogs/super_resolution/GAN_artist_critic-480.webp 480w,/assets/img/blogs/super_resolution/GAN_artist_critic-800.webp 800w,/assets/img/blogs/super_resolution/GAN_artist_critic-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogs/super_resolution/GAN_artist_critic.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">Image src: rhyme.com</figcaption> </figure> </div> </div> <p>As the generator improves with training, the discriminator’s performance gets worse because the discriminator can’t easily tell the difference between real and fake. Theoretically, the discriminator will have 50% accuracy just like the flip of a coin.</p> <blockquote> <p>So our motto is to decrease the accuracy of the people who judge us and focus on our artwork.</p> </blockquote> <h2 id="structure-of-srgan">Structure of SRGAN</h2> <div class="row mt-3"> <div class="col-xs mt-2 mx-auto"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogs/super_resolution/SRGAN-480.webp 480w,/assets/img/blogs/super_resolution/SRGAN-800.webp 800w,/assets/img/blogs/super_resolution/SRGAN-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogs/super_resolution/SRGAN.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">Image src: arxiv.org/pdf/1609.04802.pdf || Architecture of Generator and Discriminator Network with corresponding kernel size (k), number of feature maps (n) and stride (s) indicated for each convolutional layer.</figcaption> </figure> </div> </div> <h3 id="alternate-training">Alternate Training</h3> <p>The generator and discriminator are trained differently. The first discriminator is trained for one or more epochs and the generator is also trained for one or more epochs then one cycle is said to be completed. The pre-trained VGG19 model is used to extract features from the image while training.</p> <p>While training the generator the parameters of the discriminator are frozen or else the model would be hitting a moving target and never converges.</p> <h2 id="code">Code</h2> <h4 id="import-necessary-dependencies">Import necessary dependencies</h4> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="n">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="n">keras</span> <span class="kn">import</span> <span class="n">Model</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">Conv2D</span><span class="p">,</span> <span class="n">PReLU</span><span class="p">,</span><span class="n">BatchNormalization</span><span class="p">,</span> <span class="n">Flatten</span>
<span class="kn">from</span> <span class="n">keras.layers</span> <span class="kn">import</span> <span class="n">UpSampling2D</span><span class="p">,</span> <span class="n">LeakyReLU</span><span class="p">,</span> <span class="n">Dense</span><span class="p">,</span> <span class="n">Input</span><span class="p">,</span> <span class="n">add</span>
</code></pre></div></div> <h4 id="some-of-the-necessary-variables">Some of the necessary variables</h4> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">lr_ip</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">25</span><span class="p">,</span><span class="mi">25</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">hr_ip</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="mi">100</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">train_lr</span><span class="p">,</span><span class="n">train_hr</span> <span class="o">=</span> <span class="c1">#training images arrays normalized between 0 &amp; 1
</span><span class="n">test_lr</span><span class="p">,</span> <span class="n">test_hr</span> <span class="o">=</span> <span class="c1"># testing images arrays normalized between 0 &amp; 1
</span></code></pre></div></div> <h4 id="define-generator">Define Generator</h4> <p>We have to define a function to return the generator model which is used to produce the high-resolution image. Residual block is the function which returns the addition of the input layer and the final layer.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Residual block
</span><span class="k">def</span> <span class="nf">res_block</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    
    <span class="n">res_model</span> <span class="o">=</span> <span class="nc">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="sh">"</span><span class="s">same</span><span class="sh">"</span><span class="p">)(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">res_model</span> <span class="o">=</span> <span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)(</span><span class="n">res_model</span><span class="p">)</span>
    <span class="n">res_model</span> <span class="o">=</span> <span class="nc">PReLU</span><span class="p">(</span><span class="n">shared_axes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])(</span><span class="n">res_model</span><span class="p">)</span>
    
    <span class="n">res_model</span> <span class="o">=</span> <span class="nc">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span> <span class="o">=</span> <span class="sh">"</span><span class="s">same</span><span class="sh">"</span><span class="p">)(</span><span class="n">res_model</span><span class="p">)</span>
    <span class="n">res_model</span> <span class="o">=</span> <span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">momentum</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">)(</span><span class="n">res_model</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="nf">add</span><span class="p">([</span><span class="n">ip</span><span class="p">,</span><span class="n">res_model</span><span class="p">])</span>

<span class="c1"># Upscale the image 2x
</span><span class="k">def</span> <span class="nf">upscale_block</span><span class="p">(</span><span class="n">ip</span><span class="p">):</span>
    
    <span class="n">up_model</span> <span class="o">=</span> <span class="nc">Conv2D</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="sh">"</span><span class="s">same</span><span class="sh">"</span><span class="p">)(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">up_model</span> <span class="o">=</span> <span class="nc">UpSampling2D</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)(</span><span class="n">up_model</span><span class="p">)</span>
    <span class="n">up_model</span> <span class="o">=</span> <span class="nc">PReLU</span><span class="p">(</span><span class="n">shared_axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])(</span><span class="n">up_model</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">up_model</span>

<span class="c1"># Generator Model
</span><span class="k">def</span> <span class="nf">create_gen</span><span class="p">(</span><span class="n">gen_ip</span><span class="p">,</span> <span class="n">num_res_block</span><span class="o">=</span><span class="mi">16</span><span class="p">):</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nc">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="sh">"</span><span class="s">same</span><span class="sh">"</span><span class="p">)(</span><span class="n">gen_ip</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nc">PReLU</span><span class="p">(</span><span class="n">shared_axes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])(</span><span class="n">layers</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">layers</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">num_res_block</span><span class="p">):</span>
        <span class="n">layers</span> <span class="o">=</span> <span class="nf">res_block</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nc">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="sh">"</span><span class="s">same</span><span class="sh">"</span><span class="p">)(</span><span class="n">layers</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nc">BatchNormalization</span><span class="p">(</span><span class="n">momentum</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)(</span><span class="n">layers</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nf">add</span><span class="p">([</span><span class="n">layers</span><span class="p">,</span><span class="n">temp</span><span class="p">])</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nf">upscale_block</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
    <span class="n">layers</span> <span class="o">=</span> <span class="nf">upscale_block</span><span class="p">(</span><span class="n">layers</span><span class="p">)</span>
    <span class="n">op</span> <span class="o">=</span> <span class="nc">Conv2D</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span> <span class="n">padding</span><span class="o">=</span><span class="sh">"</span><span class="s">same</span><span class="sh">"</span><span class="p">)(</span><span class="n">layers</span><span class="p">)</span>
    <span class="k">return</span> <span class="nc">Model</span><span class="p">(</span><span class="n">inputs</span><span class="o">=</span><span class="n">gen_ip</span><span class="p">,</span> <span class="n">outputs</span><span class="o">=</span><span class="n">op</span><span class="p">)</span>
</code></pre></div></div> <h4 id="define-discriminator">Define Discriminator</h4> <p>This block of code defines the structure of the discriminator model, and all of the layers involved to distinguish between real and generated images. As we go deeper, after every 2 layers the number of filters increases by twice.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Small block inside the discriminator
</span><span class="k">def</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">ip</span><span class="p">,</span> <span class="n">filters</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bn</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    
    <span class="n">disc_model</span> <span class="o">=</span> <span class="nc">Conv2D</span><span class="p">(</span><span class="n">filters</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">),</span> <span class="n">strides</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="sh">"</span><span class="s">same</span><span class="sh">"</span><span class="p">)(</span><span class="n">ip</span><span class="p">)</span>
    <span class="n">disc_model</span> <span class="o">=</span> <span class="nc">LeakyReLU</span><span class="p">(</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span> <span class="p">)(</span><span class="n">disc_model</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">bn</span><span class="p">:</span>
        <span class="n">disc_model</span> <span class="o">=</span> <span class="nc">BatchNormalization</span><span class="p">(</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.8</span> <span class="p">)(</span><span class="n">disc_model</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">disc_model</span>

<span class="c1"># Discriminator Model
</span><span class="k">def</span> <span class="nf">create_disc</span><span class="p">(</span><span class="n">disc_ip</span><span class="p">):</span>
    <span class="n">df</span> <span class="o">=</span> <span class="mi">64</span>
    
    <span class="n">d1</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">disc_ip</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">bn</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">d1</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">d3</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">d2</span><span class="p">,</span> <span class="n">df</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">d4</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">d3</span><span class="p">,</span> <span class="n">df</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">d5</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">d4</span><span class="p">,</span> <span class="n">df</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">d6</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">d5</span><span class="p">,</span> <span class="n">df</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">d7</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">d6</span><span class="p">,</span> <span class="n">df</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
    <span class="n">d8</span> <span class="o">=</span> <span class="nf">discriminator_block</span><span class="p">(</span><span class="n">d7</span><span class="p">,</span> <span class="n">df</span><span class="o">*</span><span class="mi">8</span><span class="p">,</span> <span class="n">strides</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">d8_5</span> <span class="o">=</span> <span class="nc">Flatten</span><span class="p">()(</span><span class="n">d8</span><span class="p">)</span>
    <span class="n">d9</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="n">df</span><span class="o">*</span><span class="mi">16</span><span class="p">)(</span><span class="n">d8_5</span><span class="p">)</span>
    <span class="n">d10</span> <span class="o">=</span> <span class="nc">LeakyReLU</span><span class="p">(</span><span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)(</span><span class="n">d9</span><span class="p">)</span>
    <span class="n">validity</span> <span class="o">=</span> <span class="nc">Dense</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="sh">'</span><span class="s">sigmoid</span><span class="sh">'</span><span class="p">)(</span><span class="n">d10</span><span class="p">)</span>
    <span class="k">return</span> <span class="nc">Model</span><span class="p">(</span><span class="n">disc_ip</span><span class="p">,</span> <span class="n">validity</span><span class="p">)</span>
</code></pre></div></div> <h4 id="vgg19-model">VGG19 Model</h4> <p>In this code block, we use the VGG19 model trained with an image-net database to extract the features, this model is frozen later so that parameters won’t get updated.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">keras.applications</span> <span class="kn">import</span> <span class="n">VGG19</span>
<span class="c1"># Build the VGG19 model upto 10th layer 
# Used to extract the features of high res imgaes
</span><span class="k">def</span> <span class="nf">build_vgg</span><span class="p">():</span>
    <span class="n">vgg</span> <span class="o">=</span> <span class="nc">VGG19</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="sh">"</span><span class="s">imagenet</span><span class="sh">"</span><span class="p">)</span>
    <span class="n">vgg</span><span class="p">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">[</span><span class="n">vgg</span><span class="p">.</span><span class="n">layers</span><span class="p">[</span><span class="mi">9</span><span class="p">].</span><span class="n">output</span><span class="p">]</span>
    <span class="n">img</span> <span class="o">=</span> <span class="nc">Input</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="n">hr_shape</span><span class="p">)</span>
    <span class="n">img_features</span> <span class="o">=</span> <span class="nf">vgg</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
    <span class="k">return</span> <span class="nc">Model</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">img_features</span><span class="p">)</span>
</code></pre></div></div> <h4 id="combined-model">Combined Model</h4> <p>Now, we attach both the generator and discriminator model. The model obtained from this is used only to train the generator model. While training this combined model we have to freeze the discriminator in each epoch.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Attach the generator and discriminator
</span><span class="k">def</span> <span class="nf">create_comb</span><span class="p">(</span><span class="n">gen_model</span><span class="p">,</span> <span class="n">disc_model</span><span class="p">,</span> <span class="n">vgg</span><span class="p">,</span> <span class="n">lr_ip</span><span class="p">,</span> <span class="n">hr_ip</span><span class="p">):</span>
    <span class="n">gen_img</span> <span class="o">=</span> <span class="nf">gen_model</span><span class="p">(</span><span class="n">lr_ip</span><span class="p">)</span>
    <span class="n">gen_features</span> <span class="o">=</span> <span class="nf">vgg</span><span class="p">(</span><span class="n">gen_img</span><span class="p">)</span>
    <span class="n">disc_model</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">validity</span> <span class="o">=</span> <span class="nf">disc_model</span><span class="p">(</span><span class="n">gen_img</span><span class="p">)</span>
    <span class="k">return</span> <span class="nc">Model</span><span class="p">([</span><span class="n">lr_ip</span><span class="p">,</span> <span class="n">hr_ip</span><span class="p">],[</span><span class="n">validity</span><span class="p">,</span><span class="n">gen_features</span><span class="p">])</span>
</code></pre></div></div> <h4 id="declare-models">Declare models</h4> <p>Then, we declare generator, discriminator, and vgg models. Those models will be used as arguments for the combined model.</p> <blockquote> <p>Any changes in the smaller models inside the combined model also affect the model outside like weight updates, freezing the model, etc.</p> </blockquote> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">generator</span> <span class="o">=</span> <span class="nf">create_gen</span><span class="p">(</span><span class="n">lr_ip</span><span class="p">)</span>
<span class="n">discriminator</span> <span class="o">=</span> <span class="nf">create_disc</span><span class="p">(</span><span class="n">hr_ip</span><span class="p">)</span>
<span class="n">discriminator</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="sh">"</span><span class="s">binary_crossentropy</span><span class="sh">"</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">=</span><span class="sh">"</span><span class="s">adam</span><span class="sh">"</span><span class="p">,</span>      
  <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="sh">'</span><span class="s">accuracy</span><span class="sh">'</span><span class="p">])</span>
<span class="n">vgg</span> <span class="o">=</span> <span class="nf">build_vgg</span><span class="p">()</span>
<span class="n">vgg</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>
<span class="n">gan_model</span> <span class="o">=</span> <span class="nf">create_comb</span><span class="p">(</span><span class="n">generator</span><span class="p">,</span> <span class="n">discriminator</span><span class="p">,</span> <span class="n">vgg</span><span class="p">,</span> <span class="n">lr_ip</span><span class="p">,</span> <span class="n">hr_ip</span><span class="p">)</span>
<span class="n">gan_model</span><span class="p">.</span><span class="nf">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="p">[</span><span class="sh">"</span><span class="s">binary_crossentropy</span><span class="sh">"</span><span class="p">,</span><span class="sh">"</span><span class="s">mse</span><span class="sh">"</span><span class="p">],</span> <span class="n">loss_weights</span><span class="o">=</span>
  <span class="p">[</span><span class="mf">1e-3</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">optimizer</span><span class="o">=</span><span class="sh">"</span><span class="s">adam</span><span class="sh">"</span><span class="p">)</span>
</code></pre></div></div> <h4 id="sample-the-training-data-in-small-batches">Sample the training data in small batches</h4> <p>As the training set is too large, we need to sample the images into small batches to avoid <b>Resource Exhausted Error</b>. A resource such as RAM will not be enough to train all the images at once.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">train_lr_batches</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">train_hr_batches</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">int</span><span class="p">(</span><span class="n">train_hr</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">batch_size</span><span class="p">)):</span>
    <span class="n">start_idx</span> <span class="o">=</span> <span class="n">it</span> <span class="o">*</span> <span class="n">batch_size</span>
    <span class="n">end_idx</span> <span class="o">=</span> <span class="n">start_idx</span> <span class="o">+</span> <span class="n">batch_size</span>
    <span class="n">train_hr_batches</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">train_hr</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">])</span>
    <span class="n">train_lr_batches</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">train_lr</span><span class="p">[</span><span class="n">start_idx</span><span class="p">:</span><span class="n">end_idx</span><span class="p">])</span>
<span class="n">train_lr_batches</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">train_lr_batches</span><span class="p">)</span>
<span class="n">train_hr_batches</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">train_hr_batches</span><span class="p">)</span>
</code></pre></div></div> <h4 id="training-the-model">Training the model</h4> <p>This block is the core of the whole program. Here we train the discriminator and generator in the alternating method as mentioned above. As of now, the discriminator is frozen, do not forget to unfreeze before and freeze after training the discriminator, which is given in the code below.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">epochs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">epochs</span><span class="p">):</span>
    <span class="n">gen_label</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">zeros</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">real_label</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="n">batch_size</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">g_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">d_losses</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="nf">len</span><span class="p">(</span><span class="n">train_hr_batches</span><span class="p">)):</span>
        <span class="n">lr_imgs</span> <span class="o">=</span> <span class="n">train_lr_batches</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">hr_imgs</span> <span class="o">=</span> <span class="n">train_hr_batches</span><span class="p">[</span><span class="n">b</span><span class="p">]</span>
        <span class="n">gen_imgs</span> <span class="o">=</span> <span class="n">generator</span><span class="p">.</span><span class="nf">predict_on_batch</span><span class="p">(</span><span class="n">lr_imgs</span><span class="p">)</span>
        <span class="c1">#Dont forget to make the discriminator trainable
</span>        <span class="n">discriminator</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">True</span>
        
        <span class="c1">#Train the discriminator
</span>        <span class="n">d_loss_gen</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">.</span><span class="nf">train_on_batch</span><span class="p">(</span><span class="n">gen_imgs</span><span class="p">,</span>
          <span class="n">gen_label</span><span class="p">)</span>
        <span class="n">d_loss_real</span> <span class="o">=</span> <span class="n">discriminator</span><span class="p">.</span><span class="nf">train_on_batch</span><span class="p">(</span><span class="n">hr_imgs</span><span class="p">,</span>
          <span class="n">real_label</span><span class="p">)</span>
        <span class="n">discriminator</span><span class="p">.</span><span class="n">trainable</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">d_loss</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="n">d_loss_gen</span><span class="p">,</span> <span class="n">d_loss_real</span><span class="p">)</span>
        <span class="n">image_features</span> <span class="o">=</span> <span class="n">vgg</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">hr_imgs</span><span class="p">)</span>
        
        <span class="c1">#Train the generator
</span>        <span class="n">g_loss</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">gan_model</span><span class="p">.</span><span class="nf">train_on_batch</span><span class="p">([</span><span class="n">lr_imgs</span><span class="p">,</span> <span class="n">hr_imgs</span><span class="p">],</span> 
          <span class="p">[</span><span class="n">real_label</span><span class="p">,</span> <span class="n">image_features</span><span class="p">])</span>
        
        <span class="n">d_losses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">d_loss</span><span class="p">)</span>
        <span class="n">g_losses</span><span class="p">.</span><span class="nf">append</span><span class="p">(</span><span class="n">g_loss</span><span class="p">)</span>
    <span class="n">g_losses</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">g_losses</span><span class="p">)</span>
    <span class="n">d_losses</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">array</span><span class="p">(</span><span class="n">d_losses</span><span class="p">)</span>
    
    <span class="n">g_loss</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">g_losses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">g_losses</span><span class="p">)</span>
    <span class="n">d_loss</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">sum</span><span class="p">(</span><span class="n">d_losses</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="nf">len</span><span class="p">(</span><span class="n">d_losses</span><span class="p">)</span>
    <span class="nf">print</span><span class="p">(</span><span class="sh">"</span><span class="s">epoch:</span><span class="sh">"</span><span class="p">,</span> <span class="n">e</span><span class="o">+</span><span class="mi">1</span> <span class="p">,</span><span class="sh">"</span><span class="s">g_loss:</span><span class="sh">"</span><span class="p">,</span> <span class="n">g_loss</span><span class="p">,</span> <span class="sh">"</span><span class="s">d_loss:</span><span class="sh">"</span><span class="p">,</span> <span class="n">d_loss</span><span class="p">)</span>
</code></pre></div></div> <h4 id="evaluate-the-model">Evaluate the model</h4> <p>Hereby, we calculate the performance of the generator with the test dataset. The loss may be a little larger than with the training dataset, but do not worry as long as the difference is small.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">label</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="nf">ones</span><span class="p">((</span><span class="nf">len</span><span class="p">(</span><span class="n">test_lr</span><span class="p">),</span><span class="mi">1</span><span class="p">))</span>
<span class="n">test_features</span> <span class="o">=</span> <span class="n">vgg</span><span class="p">.</span><span class="nf">predict</span><span class="p">(</span><span class="n">test_hr</span><span class="p">)</span>
<span class="nb">eval</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">gan_model</span><span class="p">.</span><span class="nf">evaluate</span><span class="p">([</span><span class="n">test_lr</span><span class="p">,</span> <span class="n">test_hr</span><span class="p">],</span> <span class="p">[</span><span class="n">label</span><span class="p">,</span><span class="n">test_features</span><span class="p">])</span>
</code></pre></div></div> <h4 id="predict-the-output">Predict the output</h4> <p>We can generate high-resolution images with a generator model.</p> <div class="language-py highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">test_prediction</span> <span class="o">=</span> <span class="n">generator</span><span class="p">.</span><span class="nf">predict_on_batch</span><span class="p">(</span><span class="n">test_lr</span><span class="p">)</span>
</code></pre></div></div> <p>The output is quite amazing…</p> <div class="row mt-3"> <div class="col-xs mt-2 mx-auto"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/blogs/super_resolution/results-480.webp 480w,/assets/img/blogs/super_resolution/results-800.webp 800w,/assets/img/blogs/super_resolution/results-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/blogs/super_resolution/results.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" loading="eager" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> <figcaption class="caption">Results of the experiment</figcaption> </figure> </div> </div> <h2 id="tips">Tips</h2> <ul> <li>Always remember which model to make trainable or not.</li> <li>While training the generator use the label value as one.</li> <li>It is better to use images larger than 25x25 as they have more details for generated images.</li> <li>Do not forget to normalize the NumPy object dataset between 0 and 1 to reach minimal loss faster.</li> </ul> <h2 id="references">References</h2> <ul> <li>Jason Brownlee. 2019. Generative Adversarial Networks with Python</li> <li>Photo-Realistic Single Image Super-Resolution Using a Generative Adversarial Network — https://arxiv.org/abs/1609.04802</li> </ul> </div> </article> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2024 Manish Dhakal. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?5d75c11f89cd96294bf5e6dd1ee1bb30"></script> <script defer src="/assets/js/common.js?fcfacfb8c6281f5e68d5a7d348186eb1"></script> <script defer src="/assets/js/copy_code.js?12775fdf7f95e901d7119054556e495f" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> </body> </html>